services:
  runner:
    # 从 GitHub 容器镜像（GHCR）部署
    # 本项目使用固定镜像：ghcr.io/kittors/automa-runner:sha-f40a5fd
    # 可在 deploy/.env 或环境变量中覆盖 RUNNER_IMAGE
    image: ${RUNNER_IMAGE:-ghcr.io/kittors/automa-runner:sha-f40a5fd}
    # 离线环境建议预先 docker load 镜像；此处使用 if_not_present，避免每次强制拉取
    pull_policy: if_not_present
    user: "0:0"
    env_file:
      - ../runner/.env
    environment:
      - TZ=Asia/Shanghai
      - HOST=${HOST:-0.0.0.0}
      - PORT=${PORT:-3100}
      - OPEN_BRIDGE=${OPEN_BRIDGE:-true}
      - HEADLESS=${HEADLESS:-false}
      - PROFILE_MODE=${PROFILE_MODE:-shared}
      - PERSIST_RUN_PROFILE=${PERSIST_RUN_PROFILE:-false}
      - PW_DEBUG=${PW_DEBUG-}
      - NO_SANDBOX=${NO_SANDBOX:-true}
    ports:
      - "${PORT:-3100}:${PORT:-3100}"
    shm_size: "1gb"
    volumes:
      - type: bind
        source: ../build
        target: /app/build
        read_only: true
      - type: bind
        source: ../runner/.profile
        target: /app/runner/.profile
      - type: bind
        source: ../runner/workflows
        target: /app/runner/workflows
      - type: bind
        source: ../runner/public
        target: /app/runner/public
    restart: unless-stopped
