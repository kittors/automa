services:
  runner:
    # 本地源码构建镜像（使用 runner/Dockerfile）
    image: automa-runner:latest
    build:
      context: ../runner
      dockerfile: Dockerfile
    user: "0:0" # 以 root 运行，避免挂载目录权限问题
    env_file:
      - ../runner/.env
    environment:
      - TZ=Asia/Shanghai
      - HOST=${HOST:-0.0.0.0}
      - PORT=${PORT:-3100}
      - OPEN_BRIDGE=${OPEN_BRIDGE:-true}
      - HEADLESS=${HEADLESS:-false}
      - PROFILE_MODE=${PROFILE_MODE:-shared}
      - PERSIST_RUN_PROFILE=${PERSIST_RUN_PROFILE:-false}
      # 注意：使用 "-"（而非 ":-")，这样当 .env 中 PW_DEBUG 为空时，不会回退到默认值
      - PW_DEBUG=${PW_DEBUG-}
      - NO_SANDBOX=${NO_SANDBOX:-true}
    ports:
      - "${PORT:-3100}:${PORT:-3100}"
    # Keep Chromium stable and persist user profile across restarts
    shm_size: "1gb"
    volumes:
      # Mount the built extension directory from repo root
      - type: bind
        source: ../build
        target: /app/build
        read_only: true
      # Persist Playwright user profile to avoid first-run noise
      - type: bind
        source: ../runner/.profile
        target: /app/runner/.profile
      # Mount workflows and public demo assets for easy edits
      - type: bind
        source: ../runner/workflows
        target: /app/runner/workflows
      - type: bind
        source: ../runner/public
        target: /app/runner/public
    restart: unless-stopped
