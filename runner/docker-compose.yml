services:
  runner:
    image: automa-runner:latest
    build:
      context: .
      dockerfile: Dockerfile
    user: "0:0" # 以 root 运行，避免挂载目录权限问题
    environment:
      - PORT=${PORT:-3100}
      - OPEN_BRIDGE=${OPEN_BRIDGE:-true}
      - HEADLESS=${HEADLESS:-false}
      - PROFILE_MODE=${PROFILE_MODE:-shared}
      - PERSIST_RUN_PROFILE=${PERSIST_RUN_PROFILE:-false}
    ports:
      - "${PORT:-3100}:3100"
    # Keep Chromium stable and persist user profile across restarts
    shm_size: "1gb"
    volumes:
      # Mount the built extension directory from repo root
      - type: bind
        source: ../build
        target: /app/build
        read_only: true
      # Persist Playwright user profile to avoid first-run noise
      - type: bind
        source: ./.profile
        target: /app/runner/.profile
      # Mount workflows and public demo assets for easy edits
      - type: bind
        source: ./workflows
        target: /app/runner/workflows
      - type: bind
        source: ./public
        target: /app/runner/public
    restart: unless-stopped
